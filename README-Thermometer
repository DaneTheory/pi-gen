scp update-0.9.3.04-9.tar.gz jbuzbee@batbox.org:batbox.org/thermometer/
Thoughts

Key files

readtemp-cron.sh 
        executed via root's crontab once a minute
	Reads local sensors and writes to the sensor log file in www tree
	Currently hard-coding TZ to Denver. 
	New version loops through all detected local sensors. Old version assumes single
	Putting temperature data in /var/www/html/data dir using color and label from the same dir - sensor id as prefix. 
	Not currently handling falling back to CPU temp if no devices detected

getCurrent.cgi
	Main file for finding other sensors on IP network - avahi-browse
	Two Main parts. Update cache and Return json data
	Update Cache
		Executed via root's cron to keep cache up to date - once a minute
		Caches temperature readings from all sensors on IP network only if we have user in last 3 minutes
		Handle sensor on IP network that has multiple sensors - detects return of sensor list instead of tempereature
        	Writes /var/www/html/hosts.txt as sensors found on IP network - used in setup/setup.sh
		HouseKeeping
   	     		Deletes temperature log files if not updated in 24 hours
			Writes temperature data fetched from IP network to /var/tmp/readings 
			Copies color,label and F/C scale to /boot/config if changed
			Kills hung getCurrent.cgi processes

	Return json data for clients
		Executed via cgi call
		If cache is more than 2 minutes, call Update Cache (see above)
		Updates access timestamp to indicate current client
		Build/return JSON array from all cached sensors
			Convert to C temperature if client requested
			Filters out sensors if client requested
			Handles multiple day return if client requested


/cgi-bin/getDayTemp.cgi
	This is the avahi-advertised cgi routine
	Executed via a cgi call initiated by getCurrent.cgi
	Single-sensor system
		Returns tail of the local sensor file maintained by readtemp-cron.sh
	Multiple-sensor system
		If sensor specified, return tail of the specified sensor file maintained by readtemp-cron.sh
		if no sensor specified, return list of all sensors available, client will iterate


cron
	Copies local temperature log file to /boot/config every 5 minutes
		On power-loss, will lose at most 5 minutes of readings

rc.local
	Boot time configuration
	Housekeeping
		Makes sure certain directories exist and are accessible
		Copies temperature, label, color and scale files from /boot/config to www tree

	Update managment
		If we are in RO mode and there is an update available, change to RW mode, reboot
		If we are in RW mode and there is an update available, execute it, rename it,  change to RO, reboot 

update.sh and updateLocal.sh in /boot/config
	batbox update vs. local change (ssh daemon, password change)
	updateLocal generated via ssh.cgi and configurePassword.cgi

/cgi-bin/getSensorAttributes.sh
	Return JSON array of available sensors with label and color

/cgi-bin/checkUpdates.sh
	Executed via root's cron job once an hour
	Connects to batbox to look for updates
		If found, copy update into /boot/config, copy temperature file to /boot/config, reboot

/cgi-bin/checkLocalUpdates.sh
	Executed via cron 0 3 * * * *
	Looks for local update file (/boot/config/updateLocal.sh), if found, reboot

setup/setup.html
	Main configuration
	Current color, label, etc. - allow updates by calling configure.cgi, ssh.cgi, password.cgi, etc.

setup/configure.cgi, ssh.cgi, etc.
	Changes color, label and F/C - called from setup.html page

setup/peers.cgi
	Returns list of peers on the IP network using hosts.txt generated by getCurrent.cgi
	Used by setup.html

cgi-bin/state.cgi
	Current state of local system called from peers.cgi. Needs work for systems with multiple sensors

setup/resetData.cgi
	Clear temperature log from www and boot trees - not well tested


obsolete
	/var/www/html/setup.html
	/var/www/html/cgi-bin/getDayTemp 1 2 3 ???
	/var/www/html/label and color - need to use sensor ID prefix



/etc/nymea/nymea-networkmanager.conf
	Customizations for advertised name and start mode

/lib/systemd/system/nymea-networkmanager.service
	call our wrapper script instead of exe directly - see below

/usr/bin/nymea-networkmanager.sh
	Make thew advertised name use the CPU ID

/etc/network/if-up.d/saveNetwork
	Copy the network config to /boot/config - is this automatically called?

/etc/avahi/services/http.service
	Service to advertize the getDayTemp service for temperatures
	Note the temperature-history param is searched for in getCurrent.cgi discovery

/sbin/overlayRoot.sh
	Key file for doing overlay filesytstem at boot
	customized to update network files before the final RO setup

/boot/config.txt, /boot/cmdline
	Customizations for turning on 1-wire and using overlayRoot.sh as init

building

makeinitial - update all - long build - do daily
makethereafter - utilize from makeiniitial - shorter - use during daily iterations
unzip resutant zip file into jim dir
sym link hdd.img to latest .img
./patch.sh to fix nymea-networkmanager



scp update-0.9.3.04-9.tar.gz jbuzbee@batbox.org:batbox.org/thermometer/
MakeDistroTar.sh
